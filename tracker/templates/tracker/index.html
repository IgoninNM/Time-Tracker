<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Time Tracker</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'tracker/tracker.css' %}">
    <script type="text/javascript" src="http://d3js.org/d3.v4.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.js"></script>
    <form id="logout" method="post" action="{% url 'tracker:results' user %}">
        {% csrf_token %}
        <button type="submit" name="action" value="previous" style="float:right">Logout</button>
    </form>
</head>
<body>
     <h2 id="header">Welcome {{ user }}</h2>
     {% if messages %}
     <ul class="messages">
         {% for message in messages %}
         <li class="{{ message.tags }}" >{{ message }}</li>
         {% endfor %}
     </ul>
     {% endif %}

     <datalist id="code_options">
         {% for code in codes %}
        <option value="{{ code.Category }}"></option>
         {% endfor %}
     </datalist>

     <datalist id="subcode_options">
         {% for code in subcodes %}
        <option id="{{ code.Parent_Category }}" value="{{ code.Parent_Category }} - {{ code.SubCategory }}"></option>
         {% endfor %}
     </datalist>

     <div class="tab">
         <button class="tablinks" id="defaultOpen" onclick="openTab(event, 'form1')">Time Form</button>
         <button class="tablinks" onclick="openTab(event, 'task_list')">Entry History</button>
         <button class="tablinks" onclick="openTab(event, 'work_codes')">Categories</button>
         <button class="tablinks" onclick="openTab(event, 'analysis')">Analyze</button>
         <button class="tablinks" onclick="openTab(event, 'teams')">Teams</button>
     </div>

     <div id="form1" class="tabcontent">
            <form action="{% url 'tracker:results' user %}" method="post" id="time_form">
                {% csrf_token %}
                <br>
                <div id="labels">
                    <label style="color:#0d3473">Work Categories</label><br><br><br>
                    <label style="color:#0d3473">Description</label><br><br><br>
                    <label style="color:#0d3473">Date</label><br><br>
                    <label style="color:#175dcf">Hours</label><br><br>
                    <label style="color:#175dcf">Minutes</label><br><br>
                    OR
                    <br>
                    <br>
                    <label style="color:#175dcf">Time Start</label><br><br>
                    <label style="color:#175dcf">Time End</label><br>
                </div>
                <div id="inputs">
                    <select name="code" required id="cat" onchange="Change()">
                         {% for code in codes %}
                            <option value="{{ code.Category }}">{{ code.Category }}</option>
                         {% endfor %}
                    </select><br>
                    <select name="subcode" required id="subcat">

                    </select><br><br>
                    <textarea name="task" required autocomplete="off" placeholder="Description" style="border:1px#0d3473"></textarea><br><br><br>
                    <input type="date" name="date" required style="border:1px#0d3473"><br><br>
                    <input type="number" name="hours" value="0" max="10" min="0"><br><br>
                    <input type="number" name="minutes" value="0" max="45" step="15" min="0"><br><br>
                    <br>
                    <br>
                    <input type="time" name="start"><br><br>
                    <input type="time" name="end"><br>
                </div>
                <div id="submission">
                    <div style="border-right:2px solid white">
                        <h3>Options</h3>
                        Team: <select id="team_list"></select><br><br>
                        Rework: <input type="checkbox" name="rework"><br><br>
                    </div><br><br><br>
                </div>
                <button id="submit" type="submit" name="action" value="submission">Submit</button>
                <br>
            </form><br>
     </div>

     <div id="task_list" class="tabcontent">
        <div id="tasks">
            <h2>You've Been Working On:</h2>
            <ul>
                {% for entry in user_obj.workhour_set.all %}
                    <li><a href="{% url 'tracker:tasks' user entry.Task_Category|urlencode:'' %}">{{ entry.Task_Category }} - {{ entry.Work_Description }} - {{ entry.Hours }} Hours and {{ entry.Minutes }} Minutes, {{ entry.Date_Worked }}</a></li><br>
                {% endfor %}
            </ul>
        </div>
     </div>

     <div id="work_codes" class="tabcontent">
         <div id="code_div">
             <h2>Current Categories</h2>
             <script>
                 var div = document.getElementById("code_div");
                 for(i=0; i < document.getElementById("subcode_options").options.length; i++){
                     var lst = document.createElement("P");
                     var t = document.createTextNode(document.getElementById("subcode_options").options[i].value)
                     lst.appendChild(t);
                     div.appendChild(lst);
                 };
             </script>
         </div>
         <div id="form_div">
             <form action="{% url 'tracker:codes' user %}" method="post" id="code_form">
                 {% csrf_token %}
                 <h2>New Code: </h2>
                 <select name="new_cat" required>
                     {% for code in codes %}
                        <option value="{{ code.Category }}">{{ code.Category }}</option>
                     {% endfor %}
                 </select><br><br>
                 <input type="text" name="new_code" required autocomplete="off"><br><br>
                 <button type="submit" name="action" value="code">Submit</button>
                 <br>
                 <br>
             </form>
         </div>
     </div>

     <div id="teams" class="tabcontent">
         <div style="float:left;height:100%;width:40%;padding-left:10px;padding-right:10px;border-right:2px solid white">
             <h3>How it Works</h3>
             Teams are formed by adding an employee's username and clicking the 'Add' button.<br>
             Once all desired members of a team are added, name the team and click the 'Submit' button;
             the team will become available for selection in the time form.<br><br>
             ***NOTE: Teams are not saved. If you logout or close browser window, all teams will be lost.
         </div>
         <div style="float:left;padding-left:20px;padding-right:20px;border-right:2px solid white;height:100%;width:30%">
             <h3>Add Team Members</h3>
             Username: <br><br><input type="text" id="mem_name"><br><br><br>
             <button onclick="Team_Add()">Add Team Member</button><br>
             <br>---<br><br>
             Team Name: <br><br><input type="text" id="team_name"><br><br>
             <button onclick="Team_Create()">Submit</button>
         </div>
         <div style="float:left;text-align:center;height:100%;width:30%;padding-left:10px;padding-right:10px">
             <h3>Team Members</h3><br>
             <div id="current_team" style="background-color:white">
             </div>
         </div>
     </div>

     <div id="analysis" class="tabcontent">
         <div id="options">
             <h2>Analyze by:</h2>
             <input type="checkbox" value="Category" id="Category">Category<br>
             <input type="checkbox" value="Rework" id="Rework">Rework<br><br>
             <br>
             <h2>Time Span</h2>
             <input type="checkbox" value="Day" id="Day">Today (starting at 12:00 am today)<br>
             <input type="checkbox" value="Week" id="Week">Past 7 days (including today)<br>
             <input type="checkbox" value="Month" id="Month">Past 31 days (including today)
         </div>
         <div id="chart">
             {{ user|json_script:"user-data" }}
             <script src="/static/tracker/tt_chart.js"></script>
         </div>
     </div>

     <script>
         function openTab(evt, cityName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(cityName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        document.getElementById("defaultOpen").click();

        function Change() {
            var dict = {{cat_dict | safe}};
            var val = document.getElementById("cat").value;
            var x = document.getElementById("subcat")
            while (x.length > 0) {
                x.remove(x.length-1);
            }
            for (i in dict[val]) {
                var op = document.createElement("Option");
                op.text = dict[val][i]
                x.add(op);
            };
        }

        function Team_Add() {
            var member_name = document.getElementById("mem_name").value;
            var mem = document.createElement("P");
            var t = document.createTextNode(member_name);
            mem.appendChild(t);
            document.getElementById("current_team").appendChild(mem);
        }

        function Team_Create() {
            var new_team = document.createElement("Datalist");
            var name = document.getElementById("team_name").value;
            new_team.id = name;

            var team_list = document.getElementById("team_list");
            var team_op = document.createElement("Option");
            team_op.text = name;
            team_list.add(team_op);

            var list = document.getElementById("current_team");
            var members = list.getElementsByTagName("p");
            for (var i=0; i < members.length; ++i){
                var op = document.createElement("Option");
                op.text = members[i].innerHTML;
                new_team.appendChild(op);
            }
        }
     </script>
</body>
</html>
